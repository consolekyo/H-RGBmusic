//////////////////////////////////////////////
//51单片机音乐播放器程序					//
//共三个按键:上一曲、下一曲、播放\暂停		//
//播放完一首歌曲无按键按下时顺序播放下一曲	//
//////////////////////////////////////////////

//#include<STC12C5A60S2.H>
#include<REG52.H>
typedef unsigned char u8;



//#define sound_amount 5 //歌曲的数量
sbit play_up=P3^0;	   //上一首歌
sbit play_down=P3^1;   //下一首歌
sbit pause=P3^2;       //播放\暂停
sbit speaker=P2^0;     //无源蜂鸣器


//////////////////////////////////////////////
unsigned char timer0h,timer0l,time;//timer0h,timer0l为定时器T0的高低位初值,time为对应的节拍时间
unsigned char music_num;       //music_num为歌曲编号,music_num=0表示刚开机时的状态,num是查找歌曲数据表的地址
unsigned int num;
signed int fre;                   //对应频率数据表的地址
bit play_enable;                   //歌曲播放的使能标志位,用于播放\暂停
void delay(unsigned char t);	   //延时子函数,控制发音的时间长度
void delayms(unsigned int t);	   //普通延时子程序,可用于按键消抖
void song(void);		           //演奏一个音符
void music_play(void);	           //播放歌曲
//////////////////////////////////////////////
//每三个数字,代表一个音符
//第一个数字是音符的数值1234567之一(第几个音),代表哆来咪发...
//第二个数字是0123之一,代表低音\中音\高音\超高音(第几个八度)
//第三个数字是时间长度,以半拍为单位,乐曲数据表的结尾是三个0
//////////////////////////////////////////////

unsigned char code song1[]={
     12,1,1, 2,2,1, 4,2,4, 9,2,4, 11,2,3, 12,2,3, 4,2,10, 2,2,3, 	
	 7,2,3, 2,2,2, 12,1,8, 11,1,3, 7,1,3, 9,1,2, 5,0,2, 12,0,2, 	
	 5,1,2, 7,1,2, 9,1,3, 4,2,3, 2,2,2, 9,2,8, 7,1,1, 9,1,1, 		 
	 11,1,1, 12,1,1, 2,2,1, 4,2,1, 5,2,1, 7,2,1, 9,2,1, 11,2,1,    
	 12,2,1, 2,3,1, 4,2,4, 9,2,4, 11,2,4, 12,2,4, 11,2,4, 4,3,2, 
	 2,3,1, 12,2,1, 2,3,2, 12,2,1, 11,2,1, 12,2,1, 11,2,1, 9,2,1,  
	 7,2,1, 9,2,3, 4,2,3, 12,1,6, 2,4,2, 2,2,1, 11,1,1, 7,2,3, 	   
	 2,2,3, 11,1,6, 2,4,2, 12,1,1, 2,2,1, 4,2,1, 9,1,1, 12,1,1,    
	 9,1,1, 7,2,2, 5,2,2, 4,2,6, 2,4,2, 12,1,1, 2,2,1, 4,2,1, 	   
	 11,1,1, 2,2,1, 11,1,1, 9,2,2, 7,2,2, 4,2,2, 7,2,2, 9,2,2, 	  
	 11,2,2, 2,3,3, 4,3,3, 7,3,2, 2,3,4, 12,2,4, 11,2,2, 4,0,2,  
	 9,0,2, 11,0,2, 12,0,2, 4,1,2, 9,1,2, 11,1,2, 12,1,12, 9,1,2,
	 12,1,2, 2,2,6, 2,2,2, 2,2,2, 4,2,1, 2,2,1, 12,1,2, 11,1,2, 	
	 12,1,8, 2,4,4, 4,2,2, 7,2,2, 9,2,6, 12,2,2, 11,2,2, 9,2,2,    
	 7,2,2, 12,1,2, 2,2,2, 4,2,1, 4,2,5, 2,4,2, 4,2,2, 7,2,2, 		
	 4,2,2, 2,2,6, 2,2,2, 2,2,2, 4,2,1, 2,2,1, 12,1,2, 11,1,2, 		
	 12,1,2, 2,4,2, 2,2,2, 2,4,2, 4,2,4, 2,4,2, 9,1,1, 11,1,1, 	   
	 12,1,6, 12,1,2, 12,1,2, 12,1,2, 2,2,2, 12,1,1, 4,2,9, 2,4,4,  
	 9,1,2, 12,1,2, 										 
	 0,0,0 };

unsigned char code song2[]={
     2,2,6, 2,2,2, 2,2,2, 4,2,2, 7,2,2, 12,1,2, 11,1,2, 12,1,1, 	
	 12,1,5, 2,4,2, 12,1,2, 4,2,2, 7,2,2, 9,2,6, 12,2,2, 11,2,2, 	
	 12,2,2, 2,3,2, 11,2,2, 9,2,2, 7,2,1, 7,2,5, 2,4,6, 4,2,2, 			
	 5,2,2, 7,2,2, 9,2,2, 2,3,2, 11,2,4, 2,4,2, 2,2,2, 12,1,2, 			  
	 2,2,2, 4,2,2, 11,2,2, 9,2,4, 2,4,6, 9,2,2, 11,2,2, 12,2,2, 				 
	 2,3,3, 11,2,3, 9,2,2, 4,0,2, 12,0,2, 11,0,2, 12,0,2, 2,1,2, 					
	 4,1,2, 2,1,2, 4,1,2, 9,0,2, 2,1,2, 1,1,4, 1,2,2, 1,3,2, 						 
	 11,2,2, 11,2,2, 9,2,2, 9,2,2, 8,2,1, 9,2,3, 8,2,2, 4,2,2, 						
	 1,2,2, 4,2,8, 2,4,2, 1,2,2, 2,2,2, 4,2,2, 6,2,2, 9,1,2, 						
	 9,1,2, 9,1,1, 9,1,1, 11,1,3, 9,1,3, 1,2,10, 2,4,2, 1,2,2, 					   
	 11,1,2, 9,1,2, 9,1,6, 9,2,6, 8,2,2, 9,2,2, 11,2,3, 4,2,3, 					  
	 4,2,6, 2,4,4, 1,3,3, 11,2,3, 9,2,2, 9,2,6, 9,2,2, 2,3,3, 					
	 1,3,3, 11,2,2, 9,2,3, 6,2,3, 9,2,2, 1,3,4, 1,0,4, 2,4,2, 
	 1,0,2, 2,4,2, 2,0,4, 2,0,2, 2,0,2, 2,0,2, 4,0,2, 4,2,2, 
	 4,3,2, 2,3,2, 2,3,2, 12,2,2, 12,2,2, 11,2,1, 9,2,3, 9,2,2, 		   
	 12,2,2, 2,3,4, 12,2,2, 12,2,2, 11,2,1, 11,2,3, 11,2,2, 12,2,2, 	  
	 2,3,2, 2,4,2, 11,2,2, 12,2,2, 2,3,2, 2,4,2, 12,2,2, 2,3,2, 
	 4,3,4, 2,3,2, 2,3,2, 12,2,1, 12,2,5, 2,4,2, 4,2,2, 2,2,3, 			 
	 4,2,3, 5,2,2, 5,2,6, 5,2,2, 4,2,3, 6,2,3, 8,2,2, 11,2,4, 			 
	 2,3,4, 2,3,2, 12,2,2, 2,3,2, 12,2,1, 4,3,15, 1,3,4, 2,3,2, 		
	 4,3,4, 5,3,6, 9,2,2, 9,2,8, 4,0,4, 8,2,4, 9,2,4, 11,2,4, 			
	 2,3,3, 4,3,3, 2,3,2, 12,2,3, 4,2,3, 12,2,10, 9,2,2, 11,2,2, 	   
	 12,2,2, 12,2,8, 5,2,4, 9,2,2, 4,3,2, 2,3,4, 2,3,2, 12,2,2,    
	 11,2,4, 9,2,2, 7,2,4, 
	 0,0,0 };

unsigned char code song3[]={
     9,2,6, 12,1,2, 11,1,3, 2,2,3, 12,1,2, 11,1,3, 7,1,3, 9,1,2,   
	 9,2,2, 11,2,2, 12,2,2, 12,2,8, 5,2,2, 9,2,2, 4,3,2, 2,3,4, 					  
	 2,3,2, 12,2,2, 11,2,4, 9,2,2, 7,2,4, 11,2,6, 9,2,10, 2,4,8, 					   
	 12,2,2, 2,3,2, 4,3,2, 7,3,2, 11,3,1, 12,3,1, 11,3,1, 9,3,1, 					  
	 7,3,2, 4,3,2, 2,3,2, 12,2,2, 4,3,2, 7,3,2, 9,3,8, 2,4,2, 				 
	 9,1,2, 12,1,2, 							  
	 0,0,0 };

unsigned char code song4[]={
     0,0,0};

unsigned char code song5[]={
     11,2,6, 9,2,6, 2,2,2, 12,1,2, 11,1,3, 7,1,3, 9,1,10, 9,1,2,   
	 2,1,2, 11,1,2, 2,1,2, 12,1,2, 2,2,2, 4,2,2, 7,2,2, 9,2,8, 			 
	 2,4,2, 4,2,2, 9,2,2, 11,2,2, 1,3,2, 1,3,2, 1,3,2, 1,3,1, 		   
	 1,3,3, 1,3,2, 11,2,2, 9,2,2, 11,2,3, 8,2,3, 8,2,6, 2,4,2, 		 
	 4,2,2, 6,2,2, 6,2,2, 6,2,2, 6,2,1, 6,2,3, 6,2,1, 6,2,1, 		 
	 9,2,2, 11,2,2, 11,2,3, 1,3,3, 1,3,6, 2,4,2, 9,2,1, 11,2,1,   
	 1,3,2, 1,3,2, 1,3,2, 1,3,1, 1,3,3, 1,3,1, 1,3,1, 1,3,2, 	 
	 6,3,2, 4,3,6, 1,3,1, 11,2,1, 1,3,8, 6,2,2, 8,2,2, 9,2,2, 	  
	 9,2,4, 6,2,2, 9,2,2, 1,3,2, 2,3,3, 1,3,3, 2,3,2, 11,2,3, 	 
	 9,2,3, 11,2,2, 2,4,4, 1,3,12, 2,4,10, 1,3,2, 4,3,4, 6,3,8, 
	 4,3,6, 1,3,1, 11,2,1, 1,3,10, 9,2,2, 1,3,4, 11,2,4, 1,3,2, 	
	 8,2,2, 2,4,2, 4,2,2, 2,4,2, 6,2,10, 2,4,2, 1,2,2, 6,2,2, 		
	 8,2,2, 9,2,2, 6,2,2, 8,2,2, 9,2,2, 1,3,4, 9,3,4, 8,3,8, 	   
	 2,4,2, 8,3,2, 9,3,2, 11,3,4, 9,3,2, 8,3,2, 4,3,6, 11,2,4, 		
	 1,3,8, 2,4,2, 6,2,2, 6,2,2, 8,2,2, 9,2,2, 6,2,2, 8,2,2, 	  
	 9,2,2, 1,3,4, 9,3,3, 11,3,1, 11,3,3, 1,4,3, 9,3,2, 8,3,3, 	 
	 4,3,3, 1,3,10, 2,4,8, 9,2,1, 6,2,1, 2,2,1, 9,1,1, 2,4,2, 
	 8,2,1, 4,2,1, 11,2,1, 8,1,1, 2,4,2, 9,2,1, 6,2,1, 2,2,1, 	
	 9,1,1, 2,4,2, 11,2,1, 8,2,1, 4,2,1, 11,1,1, 2,4,2, 8,2,1, 	
	 4,2,1, 11,1,1, 9,1,1, 4,2,1, 11,1,1, 8,1,1, 4,1,1, 9,2,1, 	
	 6,2,1, 1,2,1, 9,1,1, 2,4,2, 8,2,1, 4,2,1, 11,1,1, 8,1,1, 	
	 2,4,2, 9,2,1, 6,2,1, 2,2,1, 9,1,1, 2,4,2, 11,2,1, 8,2,1, 
	 4,2,1, 11,1,1, 2,4,2, 8,2,1, 4,2,1, 11,1,1, 8,1,1, 4,2,1, 	  
	 11,1,1, 8,1,1, 4,1,1, 1,3,1, 9,2,1, 6,2,1, 1,2,1, 2,4,2, 	 
	 11,2,1, 8,2,1, 4,2,1, 11,1,1, 2,4,2, 1,3,1, 9,2,1, 6,2,1, 
	 1,2,1, 2,4,2, 4,3,1, 11,2,1, 8,2,1, 4,2,1, 2,4,2, 9,2,1, 	 
	 4,2,1, 1,2,1, 9,1,1, 8,2,1, 4,2,1, 1,2,1, 8,1,1, 9,2,1, 	 
	 6,2,1, 2,2,1, 9,1,1, 2,2,1, 6,2,1, 9,2,4, 11,2,4, 2,3,2,  
	 1,3,20, 												   
	 0,0,0 };

unsigned char code song6[]={
     2,4,10, 1,2,2, 1,3,2, 11,2,2, 11,2,2, 9,2,2, 9,2,2, 8,2,1, 	 
	 9,2,3, 8,2,2, 4,2,2, 1,2,2, 4,2,8, 2,4,2, 1,2,2, 2,2,2, 	   
	 4,2,2, 6,2,2, 9,1,2, 9,1,2, 9,1,2, 11,1,3, 9,1,3, 1,2,10, 	  
	 2,4,2, 1,2,2, 11,1,2, 9,1,2, 9,1,6, 9,2,6, 8,2,2, 9,2,2, 	 
	 11,2,3, 4,2,3, 4,2,4, 1,2,1, 2,2,1, 4,2,1, 6,2,1, 8,2,1, 	
	 9,2,1, 11,2,1, 1,3,3, 11,2,3, 9,2,8, 9,2,2, 2,3,3, 1,3,3, 	
	 11,2,2, 9,2,3, 6,2,3, 9,2,2, 1,3,2, 1,2,1, 5,2,1, 8,2,1, 	
	 1,3,1, 5,3,1, 8,3,1, 1,4,1, 8,3,1, 5,3,1, 1,3,1, 8,2,1, 	
	 5,2,1, 1,2,1, 8,1,1, 5,1,1, 1,1,4, 9,1,3, 9,1,1, 2,4,2, 	
	 11,1,4, 4,2,2, 4,3,2, 2,3,2, 2,3,2, 12,2,2, 12,2,2, 11,2,1, 
	 9,2,3, 9,2,2, 12,2,2, 2,3,4, 12,2,2, 12,2,2, 11,2,1, 11,2,3, 	
	 11,2,2, 12,2,2, 2,3,2, 2,4,2, 11,2,2, 12,2,2, 2,3,2, 2,4,2, 	
	 12,2,2, 2,3,2, 4,3,4, 2,3,2, 2,3,2, 12,2,1, 12,2,5, 2,4,2,    
	 9,2,1, 11,2,1, 12,2,10, 11,2,2, 12,2,2, 2,3,2, 2,4,4, 4,2,4, 
	 4,3,4, 2,3,4, 2,3,2, 12,2,2, 12,2,2, 11,2,1, 12,2,3, 2,3,4, 	
	 4,3,8, 1,3,4, 2,3,2, 4,3,4, 5,3,6, 9,2,2, 9,2,8, 2,4,4, 		
	 8,2,4, 9,2,4, 11,2,4, 2,3,3, 4,3,3, 2,3,2, 12,2,3, 4,2,3, 	 
	 12,2,10, 9,2,2, 11,2,2, 12,2,2, 12,2,8, 5,2,4, 9,2,2, 4,3,2, 	
	 2,3,4, 2,3,2, 12,2,2, 11,2,4, 9,2,2, 7,2,4, 9,2,6, 12,1,2,    
	 11,1,3, 2,2,3, 12,1,2, 11,1,3, 7,1,1, 2,4,2, 9,1,2, 9,2,2,    
	 11,2,2, 12,2,2, 12,2,8, 5,2,4, 9,2,2, 4,3,2, 2,3,4, 2,3,2, 	
	 12,2,2, 11,2,4, 9,2,2, 7,2,4, 11,2,6, 9,2,2, 9,0,2, 12,0,2,   
	 5,1,2, 7,1,2, 9,1,18, 2,4,20,										   	  
	 0,0,0};     

unsigned char code song7[]={
     0,0,0};

unsigned char code song8[]={
     0,0,0}; 

// 频率-半周期数据表 高八位  共保存了四个八度的28个频率数据
unsigned char code FREQH[]={
    248,248,249,249,250,250,250,251,251,251,251,252,   
	252,252,252,252,253,253,253,253,253,253,253,254,	   
	254,254,254,254,254,254,254,254,254,254,254,255,	   
	255,255,255,255,255,255,255,255,255,255,255,255,
	255,0};

// 频率-半周期数据表 低八位									
unsigned char code FREQL[]={
    140,243,91,184,21,103,185,4,75,144,207,12,	 
	68,121,172,220,9,52,92,130,166,200,226,6,		 
	34,61,86,110,133,154,174,193,211,228,244,3,		
	17,31,43,55,66,77,87,97,105,114,122,129,
	136,0}; 
void KEY()
{
	if(!pause)		//暂停键处理
		{
		delayms(5);
		if(!pause)
		{
			TR0=0;
			speaker=1;
			if(music_num==0)    //music_num=0只有在刚开机,且未按下暂停键时存在,表示刚开机时的状态,按下后从第一首开始播放
			{
				music_num=1;    //歌曲序号置1
				num=0;	        //从头播放
				play_enable=1;	//允许播放
			}
			else
			{
				play_enable=~play_enable;
			    speaker=1;
			}
			while(!pause)	 //若按着暂停键不放手时的处理
			{
			if(play_enable==0){}	        //如果是暂停，则显示时间不变//（暂停时play_enable==0）
			}

		  }//暂停键处理结束
	}//while结束

		if((!play_up)&&(music_num!=0)) //上一首按键
		{
		delayms(5);
		if((!play_up)&&(music_num!=0))
		{
		   TR0=0;
		   speaker=1;
			music_num-=1;//歌曲编号减一
			if(music_num<=0)
			music_num=8;
			num=0;		 //从头开始播放

/*			if(music_num==(sound_amount+1))
				music_num=1; 	 */
			delayms(500);//歌曲切换时延时0.5S
		}	
		}

		if((!play_down)&&(music_num!=0))
		{
		delayms(5);
		if((!play_down)&&(music_num!=0))
		{   
			TR0=0;
			speaker=1;
			music_num+=1;//歌曲编号加一
			if(music_num>=9)
			music_num=1;
			num=0;	 	 //从头开始播放

	/*		if(music_num==0)
				music_num=sound_amount;		  */
			delayms(500);//歌曲切换时延时0.5S
		}
		}
}
void main(void)
{
	TMOD=0x11; //T0 T1 均在工作方式1
	ET0=1;  //T0开中断
	EA=1;   //CPU开中断	 
	while(1)
	{
		music_play();	//根据当前状态播放相应歌曲的某个音符

		KEY();

	}
} 

void delayms(unsigned int t)	   //MS延时子程序
{
	unsigned int i,j;
	for(i=0;i<t;i++)
	{
		for(j=0;j<123;j++)
			;
	}
}

void delay(unsigned char t)	    //延时子函数,控制发音的时间长度,每个节拍0.4S
{
	unsigned char t1;
	unsigned long t2;
	for(t1=0;t1<t;t1++)	       //嵌套循环, 共延时t个半拍
	{
    	for(t2=0;t2<2000;t2++) //延时期间, 可进入T0中断去发音
        {
        	KEY();
        }
	}
	TR0=0;		               //关闭T0, 停止发音
}

void timer0(void) interrupt 1  //T0中断程序,控制发音的音调
{
#if(0)
    
    static u8 ci = 2;   //占空，减小音量
    static u8 ciRL = 2;
    if(ci){
        ci--;
    }else{
        ci = ciRL;
        speaker=!speaker;//输出方波, 发音
    }  
#endif    

    
    speaker=!speaker;//输出方波, 发音
	TH0=timer0h;	 //下次的中断时间,这个时间控制音调高低
	TL0=timer0l;
 }

void song(void)  	//演奏一个音符
{
	TH0=timer0h;    //控制音调
	TL0=timer0l;
	if((timer0h!=0)||(timer0l!=0))
		TR0=1;		    //启动T0, 由T0输出方波发音
	delay(time);    //每个音符的演奏时间
}
////////////////////////////////////////////////////////////////////////////////////
void music_play(void)//播放相应歌曲的某个音符
{
	if((music_num==1)&&(play_enable==1))
	{
		fre=song1[num]+12*song1[num+1]-1;//第i个是音符,第i+1个是第几个八度
		timer0h=FREQH[fre];	            //从数据表中读出频率数值,实际上是定时的时间长度
    	timer0l=FREQL[fre];
    	time=song1[num+2];              //读出时间长度数值
    	num+=3;
		if(fre<0)		//判断歌曲的结束位,结束后转到下一首
		{
			num=0;	    //下一首从头播放
			music_num=2;
    	}
		song();	        //发出一个音符
	}
////////////////////////////////////////////////////////////////////////////////////
	if((music_num==2)&&(play_enable==1))
	{  
		fre=song2[num]+12*song2[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song2[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=3;
    	}
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
		if((music_num==3)&&(play_enable==1))
	{  
		fre=song3[num]+12*song3[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song3[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=4;
    	}
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
	if((music_num==4)&&(play_enable==1))
	{
		fre=song2[num]+12*song2[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song2[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=5;
    	}								 
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
	if((music_num==5)&&(play_enable==1))
	{
		fre=song5[num]+12*song5[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song5[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=6;
    	}
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
	if((music_num==6)&&(play_enable==1))
	{
		fre=song6[num]+12*song6[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song6[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=1;
    	}
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
if((music_num==7)&&(play_enable==1))
	{
		fre=song7[num]+12*song7[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song7[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=1;
    	}
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
if((music_num==8)&&(play_enable==1))
	{
		fre=song8[num]+12*song8[num+1]-1;
		timer0h=FREQH[fre];
    	timer0l=FREQL[fre];
    	time=song8[num+2];
    	num+=3;
		if(fre<0)
		{
			num=0;
			music_num=1;
    	}
		song();		
	}
////////////////////////////////////////////////////////////////////////////////////
}
//程序结束

